<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-lang="page_title">Current Health Status</title>

<link rel="stylesheet" href="consult.css">

<style>
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 22px; margin-bottom: 22px; }
.grid-1 { margin-bottom: 22px; }
.section-title { font-size: 16px; font-weight: 600; margin: 28px 0 14px; }
.subtitle { font-size: 13px; color: #666; margin-bottom: 22px; }
input:disabled { background: #f4f6f8; color: #888; }
.error { color: red; font-size: 12px; margin-top: 6px; display: block; }

.form-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
.btn-prev { padding: 12px 24px; background: #e5e7eb; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
.btn-next { padding: 12px 24px; background: #16a34a; color: #fff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
.btn-next:hover { background: #15803d; }
</style>
</head>

<body>
<div class="page-wrapper">

  <div class="page-title" data-lang="page_heading">Patient Registration</div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-lang="tab_personal">Personal Information</div>
    <div class="tab active" data-lang="tab_lifestyle">Lifestyle & Social History</div>
    <div class="tab active" data-lang="tab_medical">Medical History</div>
    <div class="tab active" data-lang="tab_current">Current Health Status</div>
    <div class="tab" data-lang="tab_ayush">AYUSH Profile</div>
    <div class="tab" data-lang="tab_image">Image Capture</div>
  </div>

  <div class="form-card">
    <h3 data-lang="form_title">Current Health Status</h3>
    <p class="subtitle" data-lang="form_subtitle">Please fill all required fields</p>

    <!-- Vitals -->
    <div class="grid-3">
      <div>
        <label data-lang="height">Height (cm) *</label>
        <input type="number" id="height" data-lang-placeholder="enter_height">
        <small class="error"></small>
      </div>

      <div>
        <label data-lang="weight">Weight (kg) *</label>
        <input type="number" id="weight" data-lang-placeholder="enter_weight">
        <small class="error"></small>
      </div>

      <div>
        <label data-lang="bmi">BMI</label>
        <input type="text" id="bmi" disabled>
      </div>
    </div>

    <div class="grid-3">
      <div>
        <label data-lang="blood_pressure">Blood Pressure *</label>
        <input type="text" id="bloodPressure" data-lang-placeholder="enter_blood">
        <small class="error"></small>
      </div>
      <div>
        <label data-lang="pulse_rate">Pulse Rate *</label>
        <input type="text" id="pulseRate" data-lang-placeholder="enter_pulse">
        <small class="error"></small>
      </div>
      <div>
        <label data-lang="temperature">Temperature *</label>
        <input type="text" id="temperature" data-lang-placeholder="enter_temp">
        <small class="error"></small>
      </div>
    </div>

    <div class="grid-1">
      <label data-lang="symptoms">Present Symptoms *</label>
      <textarea id="symptoms" data-lang-placeholder="enter_symptoms"></textarea>
      <small class="error"></small>
    </div>

    <div class="grid-1">
      <label data-lang="pain_areas">Pain Areas / Physical Discomfort *</label>
      <textarea id="painAreas" data-lang-placeholder="enter_pain"></textarea>
      <small class="error"></small>
    </div>

    <div class="grid-1" id="reproductiveSection">
      <label data-lang="reproductive">Menstrual / Reproductive Health *</label>
      <textarea id="reproductiveHealth" data-lang-placeholder="enter_reproductive"></textarea>
      <small class="error"></small>
    </div>

    <div class="section-title" data-lang="mental_title">Mental Health Status</div>

    <div class="grid-3">
      <div>
        <select id="stressLevel">
          <option value="" data-lang="stress_placeholder">Stress Level *</option>
          <option data-lang="low">Low</option>
          <option data-lang="moderate">Moderate</option>
          <option data-lang="high">High</option>
        </select>
        <small class="error"></small>
      </div>

      <div>
        <select id="depressionLevel">
          <option value="" data-lang="depression_placeholder">Depression *</option>
          <option data-lang="none">None</option>
          <option data-lang="mild">Mild</option>
          <option data-lang="moderate">Moderate</option>
        </select>
        <small class="error"></small>
      </div>

      <div>
        <select id="anxietyLevel">
          <option value="" data-lang="anxiety_placeholder">Anxiety *</option>
          <option data-lang="none">None</option>
          <option data-lang="mild">Mild</option>
          <option data-lang="moderate">Moderate</option>
        </select>
        <small class="error"></small>
      </div>
    </div>

    <div class="form-buttons">
      <button class="btn-prev" id="prevBtn" data-lang="prev_btn">‚Üê Previous</button>
      <button class="btn-next" id="nextBtn" data-lang="next_btn">Save & Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- üåê TRANSLATIONS -->
<script>
const translations = {
  en: {
    page_title: "Current Health Status",
  page_heading: "Patient Registration",
    tab_personal: "Personal Information",
    tab_lifestyle: "Lifestyle & Social History",
    tab_medical: "Medical History",
    tab_current: "Current Health Status",
    tab_ayush: "AYUSH Profile",
    tab_image: "Image Capture",
    form_title: "Current Health Status",
    form_subtitle: "Please fill all required fields",
    height: "Height (cm)",
    enter_height: "Enter height in cm",
    weight: "Weight (kg)",
    enter_weight: "Enter weight in kg",
    bmi: "BMI",
    blood_pressure: "Blood Pressure",
    enter_blood: "Enter blood pressure",
    pulse_rate: "Pulse Rate",
    enter_pulse: "Enter pulse rate",
    temperature: "Temperature",
    enter_temp: "Enter temperature",
    symptoms: "Present Symptoms",
    enter_symptoms: "Describe symptoms",
    pain_areas: "Pain Areas / Physical Discomfort",
    enter_pain: "Enter pain areas",
    reproductive: "Menstrual / Reproductive Health",
    enter_reproductive: "Enter details",
    mental_title: "Mental Health Status",
    stress_placeholder: "Stress Level *",
    low: "Low",
    moderate: "Moderate",
    high: "High",
    depression_placeholder: "Depression *",
    none: "None",
    mild: "Mild",
    anxiety_placeholder: "Anxiety *",
    prev_btn: "‚Üê Previous",
    next_btn: "Save & Next ‚Üí",
    err_required: "Required",
    err_patient_not_found: "Patient not found",
    err_server: "Server error"
  },
  hi: {
  
    page_title: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
  page_heading: "‡§∞‡•ã‡§ó‡•Ä ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£",
    tab_personal: "‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä",
    tab_lifestyle: "‡§ú‡•Ä‡§µ‡§®‡§∂‡•à‡§≤‡•Ä ‡§î‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§á‡§§‡§ø‡§π‡§æ‡§∏",
    tab_medical: "‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏",
    tab_current: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
    tab_ayush: "‡§Ü‡§Ø‡•Å‡§∑ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤",
    tab_image: "‡§õ‡§µ‡§ø ‡§ï‡•à‡§™‡•ç‡§ö‡§∞",
    form_title: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
    form_subtitle: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç",
    height: "‡§ä‡§Å‡§ö‡§æ‡§à (‡§∏‡•á‡§Æ‡•Ä)",
    enter_height: "‡§ä‡§Å‡§ö‡§æ‡§à ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    weight: "‡§µ‡§ú‡§º‡§® (‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ)",
    enter_weight: "‡§µ‡§ú‡§º‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    bmi: "‡§¨‡•Ä‡§è‡§Æ‡§Ü‡§à",
    blood_pressure: "‡§∞‡§ï‡•ç‡§§‡§ö‡§æ‡§™",
    enter_blood: "‡§∞‡§ï‡•ç‡§§‡§ö‡§æ‡§™ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    pulse_rate: "‡§®‡§æ‡§°‡§º‡•Ä ‡§¶‡§∞",
    enter_pulse: "‡§®‡§æ‡§°‡§º‡•Ä ‡§¶‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    temperature: "‡§§‡§æ‡§™‡§Æ‡§æ‡§®",
    enter_temp: "‡§§‡§æ‡§™‡§Æ‡§æ‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    symptoms: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≤‡§ï‡•ç‡§∑‡§£",
    enter_symptoms: "‡§≤‡§ï‡•ç‡§∑‡§£ ‡§≤‡§ø‡§ñ‡•á‡§Ç",
    pain_areas: "‡§¶‡§∞‡•ç‡§¶ ‡§ï‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ / ‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï ‡§Ö‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ",
    enter_pain: "‡§¶‡§∞‡•ç‡§¶ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    reproductive: "‡§Æ‡§æ‡§∏‡§ø‡§ï / ‡§™‡•ç‡§∞‡§ú‡§®‡§® ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø",
    enter_reproductive: "‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
    mental_title: "‡§Æ‡§æ‡§®‡§∏‡§ø‡§ï ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
    stress_placeholder: "‡§§‡§®‡§æ‡§µ ‡§∏‡•ç‡§§‡§∞ *",
    low: "‡§ï‡§Æ",
    moderate: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ",
    high: "‡§â‡§ö‡•ç‡§ö",
    depression_placeholder: "‡§Ö‡§µ‡§∏‡§æ‡§¶ *",
    none: "‡§®‡§π‡•Ä‡§Ç",
    mild: "‡§π‡§≤‡•ç‡§ï‡§æ",
    anxiety_placeholder: "‡§ö‡§ø‡§Ç‡§§‡§æ *",
    prev_btn: "‚Üê ‡§™‡§ø‡§õ‡§≤‡§æ",
    next_btn: "‡§∏‡§π‡•á‡§ú‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§ó‡•á ‚Üí",
    err_required: "‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï",
    err_patient_not_found: "‡§∞‡•ã‡§ó‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ",
    err_server: "‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"
  },
  kn: {
   page_title: "‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
  page_heading: "‡≤∞‡≥ã‡≤ó‡≤ø ‡≤®‡≥ã‡≤Ç‡≤¶‡≤£‡≤ø",
    tab_personal: "‡≤µ‡≥à‡≤Ø‡≤ï‡≥ç‡≤§‡≤ø‡≤ï ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø",
    tab_lifestyle: "‡≤ú‡≥Ä‡≤µ‡≤®‡≤∂‡≥à‡≤≤‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤æ‡≤Æ‡≤æ‡≤ú‡≤ø‡≤ï ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏",
    tab_medical: "‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤ï‡≥Ä‡≤Ø ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏",
    tab_current: "‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
    tab_ayush: "‡≤Ü‡≤Ø‡≥Å‡≤∑‡≥ç ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç",
    tab_image: "‡≤ö‡≤ø‡≤§‡≥ç‡≤∞ ‡≤∏‡≥Ü‡≤∞‡≥Ü‡≤π‡≤ø‡≤°‡≤ø‡≤§",
    form_title: "‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
    form_subtitle: "‡≤é‡≤≤‡≥ç‡≤≤‡≤æ ‡≤Ö‡≤ó‡≤§‡≥ç‡≤Ø ‡≤ï‡≥ç‡≤∑‡≥á‡≤§‡≥ç‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≠‡≤∞‡≥ç‡≤§‡≤ø ‡≤Æ‡≤æ‡≤°‡≤ø",
    height: "‡≤é‡≤§‡≥ç‡≤§‡≤∞ (‡≤∏‡≥Ü‡≤Ç‡≤Æ‡≥Ä)",
    enter_height: "‡≤é‡≤§‡≥ç‡≤§‡≤∞ ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    weight: "‡≤§‡≥Ç‡≤ï (‡≤ï‡≤ø.‡≤ó‡≥ç‡≤∞‡≤æ)",
    enter_weight: "‡≤§‡≥Ç‡≤ï ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    bmi: "‡≤¨‡≤ø‡≤é‡≤Ç‡≤ê",
    blood_pressure: "‡≤∞‡≤ï‡≥ç‡≤§‡≤¶ ‡≤í‡≤§‡≥ç‡≤§‡≤°",
    enter_blood: "‡≤∞‡≤ï‡≥ç‡≤§‡≤¶ ‡≤í‡≤§‡≥ç‡≤§‡≤° ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    pulse_rate: "‡≤®‡≤æ‡≤≥‡≤ø ‡≤¶‡≤∞",
    enter_pulse: "‡≤®‡≤æ‡≤≥‡≤ø ‡≤¶‡≤∞ ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    temperature: "‡≤§‡≤æ‡≤™‡≤Æ‡≤æ‡≤®",
    enter_temp: "‡≤§‡≤æ‡≤™‡≤Æ‡≤æ‡≤® ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    symptoms: "‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥‡≥Å",
    enter_symptoms: "‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    pain_areas: "‡≤®‡≥ã‡≤µ‡≥Å ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤ó‡≤≥‡≥Å / ‡≤¶‡≥à‡≤π‡≤ø‡≤ï ‡≤Ö‡≤∏‡≥å‡≤ï‡≤∞‡≥ç‡≤Ø",
    enter_pain: "‡≤®‡≥ã‡≤µ‡≥Å ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    reproductive: "‡≤Æ‡≤æ‡≤∏‡≤ø‡≤ï / ‡≤™‡≥ç‡≤∞‡≤ú‡≤®‡≤® ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø",
    enter_reproductive: "‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø",
    mental_title: "‡≤Æ‡≤æ‡≤®‡≤∏‡≤ø‡≤ï ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
    stress_placeholder: "‡≤Æ‡≤®‡≥ã‡≤¶‡≤¨‡≥ç‡≤¨‡≤≥‡≤ø ‡≤Æ‡≤ü‡≥ç‡≤ü *",
    low: "‡≤ï‡≤°‡≤ø‡≤Æ‡≥Ü",
    moderate: "‡≤Æ‡≤ß‡≥ç‡≤Ø‡≤Æ",
    high: "‡≤Ö‡≤ß‡≤ø‡≤ï",
    depression_placeholder: "‡≤Ö‡≤µ‡≤∏‡≤æ‡≤¶ *",
    none: "‡≤á‡≤≤‡≥ç‡≤≤",
    mild: "‡≤∏‡≤æ‡≤Æ‡≤æ‡≤®‡≥ç‡≤Ø",
    anxiety_placeholder: "‡≤ö‡≤ø‡≤Ç‡≤§‡≥Ü *",
    prev_btn: "‚Üê ‡≤π‡≤ø‡≤Ç‡≤¶‡≤ø‡≤®‡≤¶‡≥Å",
    next_btn: "‡≤â‡≤≥‡≤ø‡≤∏‡≤ø ‡≤Æ‡≥Å‡≤Ç‡≤¶‡≥Å‡≤µ‡≤∞‡≤ø‡≤∏‡≤ø ‚Üí",
    err_required: "‡≤Ö‡≤ó‡≤§‡≥ç‡≤Ø",
    err_patient_not_found: "‡≤∞‡≥ã‡≤ó‡≤ø ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤",
    err_server: "‡≤∏‡≤∞‡≥ç‡≤µ‡≤∞‡≥ç ‡≤¶‡≥ã‡≤∑"
  }
};
</script>

<!-- üåê APPLY LANGUAGE -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const lang = localStorage.getItem("language") || "en";

  document.querySelectorAll("[data-lang]").forEach(el => {
    const key = el.dataset.lang;
    if (translations[lang][key]) el.innerText = translations[lang][key];
  });

  document.querySelectorAll("[data-lang-placeholder]").forEach(el => {
    const key = el.dataset.langPlaceholder;
    if (translations[lang][key]) el.placeholder = translations[lang][key];
  });
});
</script>

<script>
const API_BASE = "http://localhost:5000/api/patients";
const reproductiveSection = document.getElementById("reproductiveSection");
const gender = localStorage.getItem("gender");

if (gender !== "Female") {
  reproductiveSection.style.display = "none";
}

/* BMI calculation */
function calcBMI(){
  if(height.value && weight.value){
    bmi.value = (weight.value / ((height.value/100) ** 2)).toFixed(1);
  }
}
height.oninput = calcBMI;
weight.oninput = calcBMI;

/* LOAD STEP 4 */
document.addEventListener("DOMContentLoaded", async () => {
  const patientId = localStorage.getItem("patientId");
  if (!patientId) return;

  try {
    const res = await fetch(`${API_BASE}/${patientId}`);
    if (!res.ok) return;

    const data = await res.json();
    if (!data.step4) return;

    const s = data.step4;

    height.value = s.vitals?.height || "";
    weight.value = s.vitals?.weight || "";
    bmi.value = s.vitals?.bmi || "";
    bloodPressure.value = s.vitals?.bloodPressure || "";
    pulseRate.value = s.vitals?.pulseRate || "";
    temperature.value = s.vitals?.temperature || "";
    symptoms.value = s.symptoms || "";
    painAreas.value = s.painAreas || "";
    reproductiveHealth.value = s.reproductiveHealth || "";
    stressLevel.value = s.mentalHealth?.stress || "";
    depressionLevel.value = s.mentalHealth?.depression || "";
    anxietyLevel.value = s.mentalHealth?.anxiety || "";

    calcBMI();
  } catch (err) {
    console.error("Load error:", err);
  }
});

/* VALIDATION */
function validate(){
  let ok = true;
  const lang = localStorage.getItem("language") || "en";
  const t = translations[lang];

  document.querySelectorAll(".error").forEach(e => e.textContent = "");

  if(!height.value){ height.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!weight.value){ weight.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!bloodPressure.value){ bloodPressure.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!pulseRate.value){ pulseRate.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!temperature.value){ temperature.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!symptoms.value){ symptoms.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!painAreas.value){ painAreas.nextElementSibling.textContent = t.err_required; ok=false; }
  if(reproductiveSection.style.display !== "none" && !reproductiveHealth.value){ reproductiveHealth.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!stressLevel.value){ stressLevel.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!depressionLevel.value){ depressionLevel.nextElementSibling.textContent = t.err_required; ok=false; }
  if(!anxietyLevel.value){ anxietyLevel.nextElementSibling.textContent = t.err_required; ok=false; }

  return ok;
}

/* SAVE STEP 4 */
nextBtn.onclick = async () => {
  if (!validate()) return;

  const patientId = localStorage.getItem("patientId");
  const t = translations[localStorage.getItem("language") || "en"];

  if (!patientId) {
    alert(t.err_patient_not_found);
    return;
  }

  const step4 = {
    vitals: {
      height: height.value,
      weight: weight.value,
      bmi: bmi.value,
      bloodPressure: bloodPressure.value,
      pulseRate: pulseRate.value,
      temperature: temperature.value
    },
    symptoms: symptoms.value,
    painAreas: painAreas.value,
    reproductiveHealth: reproductiveHealth.value,
    mentalHealth: {
      stress: stressLevel.value,
      depression: depressionLevel.value,
      anxiety: anxietyLevel.value
    }
  };

  try {
    const res = await fetch(`${API_BASE}/${patientId}/step4`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ step4 })
    });

    if (!res.ok) throw new Error("Failed to save step4");

    location.href = "consult6.html";
  } catch (err) {
    alert(translations[localStorage.getItem("language") || "en"].err_server);
    console.error(err);
  }
};

prevBtn.onclick = () => location.href = "consult3.html";
</script>
</body>
</html>
